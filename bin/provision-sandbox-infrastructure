#!/usr/bin/env python
import argparse

from openedx_configuration.lib import *
from openedx_configuration.models.vpc.vpc import Vpc
from openedx_configuration.models.vpc.gateway import Gateway
from openedx_configuration.models.vpc.route_table import RouteTable
from openedx_configuration.models.vpc.subnet import Subnet
from openedx_configuration.models.ec2.security_group import SecurityGroup


DESCRIPTION_SECURITY_GROUP = 'TODO: something smart here'


class Stack(object):
    def __init__(self, vpc):
        self.vpc = vpc

    def destroy(self):
        vpc = self.vpc
        print('wtf', RouteTable.all(vpc))
        for route_table in RouteTable.all(vpc):
            route_table.destroy()
        for security_group in SecurityGroup.all(vpc):
            security_group.destroy()
        for subnet in Subnet.all(vpc):
            subnet.destroy()
        for gateway in Gateway.all(vpc):
            gateway.destroy()
        vpc.destroy()

def _get_all(arguments):
    api_vpc = VPCConnection()
    api_ec2 = EC2Connection()
    environment = arguments.environment
    vpc_name = arguments.vpc_name
    vpc_cidr_block = arguments.vpc_cidr_block
    subnet_cidr_block = arguments.subnet_cidr_block
    vpc = Vpc(environment, vpc_name, api=api_vpc)
    gateway = Gateway(
        environment,
        'sandbox-internet',
        vpc=vpc,
        api=api_vpc,
    )
    subnet = Subnet(
        environment,
        name='sandbox-public',
    )
    security_group = SecurityGroup(
        environment,
        name='public-sandbox-openedx',
        api=api_ec2,
    )
    route_table = RouteTable(
        environment,
        name='sandbox-route-public',
        subnet=subnet,
        api=api_vpc,
    )
    return (
        vpc,
        gateway,
        subnet,
        security_group,
        route_table,
    )


def describe(arguments):
    (vpc, gateway, subnet, security_group, route_table) = _get_all(arguments)
    for item in _get_all(arguments):
        print(item.exists, item.name, item.environment, item)
        print
    return False


def create(arguments):
    (vpc, gateway, subnet, security_group, route_table) = _get_all(arguments)
    vpc.create(cidr_block=arguments.vpc_cidr_block)
    gateway.create()
    print('create subnet', arguments.subnet_cidr_block)
    subnet.create(arguments.subnet_cidr_block)
    security_group.create(DESCRIPTION_SECURITY_GROUP)
    route_table.create(gateway.id, PUBLIC_CIDR_BLOCK)

def destroy(arguments):
    _all = _get_all(arguments)
    vpc = _all[0]
    stack = Stack(vpc)
    stack.destroy()
    print(stack)

if __name__ == '__main__':
    parser = argparse.ArgumentParser(
        description='Whatever, man',
    )
    parser.add_argument(
        '-V',
        '--vpc-cidr-block',
        # help='breath life with a name',
        default='10.4.0.0/16'
    )
    parser.add_argument(
        '-s',
        '--subnet-cidr-block',
        # help='breath life with a name',
        default='10.4.0.0/24'
    )
    parser.add_argument(
        '-a',
        '--action',
        help='create/describe/destroy',
        default='describe'
    )
    parser.add_argument(
        '-n',
        '--vpc-name',
        help='?',
        default=None,
    )
    parser.add_argument(
        '-e',
        '--environment',
        help='?',
        default='sandbox',
    )
    arguments = parser.parse_args()
    if not arguments.vpc_name:
        arguments.vpc_name = arguments.environment
    if arguments.action == 'describe':
        describe(arguments)
    elif arguments.action == 'create':
        create(arguments)
    elif arguments.action == 'destroy':
        destroy(arguments)
