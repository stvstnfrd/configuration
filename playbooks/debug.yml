- hosts: localhost
  sudo: True
  vars:
    secure_dir: '../../configuration-secure/ansible'
    playbook_dir: '../../configuration/playbooks'
  vars_files:
    - "{{ playbook_dir }}/roles/common/defaults/main.yml"
    - "{{ playbook_dir }}/roles/edxapp/defaults/main.yml"

    - "{{ secure_dir }}/vars/common/platform/defaults.yaml"
    - "{{ secure_dir }}/vars/common/platform/embargo.yaml"
    - "{{ secure_dir }}/vars/common/platform/git-identity.yaml"
    - "{{ secure_dir }}/vars/common/platform/env.yaml"
    - "{{ secure_dir }}/vars/common/platform/auth.yaml"
    - "{{ secure_dir }}/vars/common/lms/features.yaml"
    - "{{ secure_dir }}/vars/common/lms/microsites.yaml"
    - "{{ secure_dir }}/vars/common/lms/env.yaml"
    - "{{ secure_dir }}/vars/common/lms/auth.yaml"
    - "{{ secure_dir }}/vars/common/cms/env.yaml"
    - "{{ secure_dir }}/vars/common/cms/auth.yaml"

    - "{{ secure_dir }}/vars/{{ env }}/platform/defaults.yaml"
    - "{{ secure_dir }}/vars/{{ env }}/platform/env.yaml"
    - "{{ secure_dir }}/vars/{{ env }}/platform/auth.yaml"
    - "{{ secure_dir }}/vars/{{ env }}/lms/env.yaml"
    - "{{ secure_dir }}/vars/{{ env }}/lms/auth.yaml"
    - "{{ secure_dir }}/vars/{{ env }}/cms/env.yaml"
    - "{{ secure_dir }}/vars/{{ env }}/cms/auth.yaml"
  tasks:
    - debug: var=playbook_dir
    - name: "create {{ item }} env file"
      template:
        src="{{ playbook_dir }}/playbooks/roles/edxapp/templates/{{ item }}.env.json.j2"
        dest="/tmp/{{ env }}.{{ item }}.env.json"
      sudo_user: "{{ edxapp_user }}"
      with_items:
        - 'lms'
        - 'cms'
    - name: "create {{ item }} auth file"
      template: >
        src="{{ playbook_dir }}/playbooks/roles/edxapp/templates/{{ item }}.auth.json.j2"
        dest="/tmp/{{ env }}.{{ item }}.auth.json"
      sudo_user: "{{ edxapp_user }}"
      with_items:
        - 'lms'
        - 'cms'
