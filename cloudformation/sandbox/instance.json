{
    {
        "WebServerInstance" : {
            "Type" : "AWS::EC2::Instance",
            "DependsOn" : "AttachGateway",
            "Metadata" : {
                "Comment" : "Install a simple application",
                "AWS::CloudFormation::Init" : {
                    "config" : {
                        "packages" : {
                            "yum" : {
                                "httpd": []
                            }
                        },
                        "services" : {
                            "sysvinit" : {
                                "httpd"    : {
                                    "enabled" : "true",
                                    "ensureRunning" : "true"
                                },
                                "cfn-hup" : {
                                    "enabled" : "true",
                                    "ensureRunning" : "true",
                                    "files" : [
                                        "/etc/cfn/cfn-hup.conf",
                                        "/etc/cfn/hooks.d/cfn-auto-reloader.conf"
                                    ]
                                }
                            }
                        }
                    }
                }
            },
            "Properties" : {
                "ImageId" : {
                    "Fn::FindInMap": [
                        "AWSRegionArch2AMI",
                        { "Ref": "AWS::Region" },
                        {
                            "Fn::FindInMap": [
                                "AWSInstanceType2Arch",
                                { "Ref" : "InstanceType" },
                                "Arch"
                            ]
                        }
                    ]
                },
                "InstanceType" : { "Ref" : "InstanceType" },
                "KeyName" : { "Ref" : "KeyName" },
                "Tags" : [
                    {"Key" : "Name", "Value" : "jenkins.sandbox"},
                    {"Key" : "Application", "Value" : { "Ref" : "AWS::StackId"} }
                ],
                "NetworkInterfaces" : [
                    {
                        "GroupSet": [{ "Ref" : "InstanceSecurityGroup" }],
                        "AssociatePublicIpAddress": "true",
                        "DeviceIndex": "0",
                        "DeleteOnTermination": "true",
                        "SubnetId": { "Ref" : "Subnet" }
                    }
                ],
                "UserData"       : { "Fn::Base64" : { "Fn::Join" : ["", [
                    "#!/bin/bash -xe\n",
                    "apt-get -y install python-setuptools\n",
                    "easy_install https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz\n",
                    "cfn-init -v ",
                    "         --stack ", { "Ref" : "AWS::StackName" },
                    "         --resource WebServerInstance ",
                    "         --region ", { "Ref" : "AWS::Region" }, "\n",
                    "cfn-signal --exit-code ${?} ",
                    "         --stack ", { "Ref" : "AWS::StackName" },
                    "         --resource WebServerInstance ",
                    "         --region ", { "Ref" : "AWS::Region" }, "\n"
                ]]}}
            },
            "CreationPolicy" : {
                "ResourceSignal" : {
                    "Timeout" : "PT1M"
                }
            }
        }
    },
    "Outputs": {
        "URL" : {
            "Value" : { "Fn::Join" : [ "", ["http://", { "Fn::GetAtt" : ["WebServerInstance", "PublicIp"] }]]},
            "Description" : "Newly created application URL"
        }
    }
}
